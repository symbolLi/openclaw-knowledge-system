# OpenClaw知识库系统 - 分阶段开发计划（最终版）

## 📋 **总体原则**
- **每个阶段独立可运行**：不依赖后续阶段功能
- **结果可验证**：每个阶段都有明确的验收标准
- **渐进式交付**：从核心功能开始，逐步扩展
- **风险控制**：先验证技术可行性，再投入复杂功能
- **用户体验优先**：保持操作极简，避免增加用户负担

---

## 🚀 **阶段1：基础架构搭建 (v0.0.1)**

### 阶段目标
建立完整的项目基础架构，验证OpenClaw集成可行性

### 开发范围
- 项目目录结构和基础配置
- 知识库数据库初始化
- 基础文件存储结构
- OpenClaw命令集成配置

### 验收标准 ✅
- [x] GitHub仓库包含完整项目结构
- [x] SQLite数据库成功创建并初始化表结构
- [x] OpenClaw配置正确指向知识库脚本
- [x] 能够通过OpenClaw命令调用基础脚本（返回"Hello World"）

### 预期交付物
- `package.json` - 项目依赖和脚本
- `lib/database.js` - 数据库初始化和基础操作
- `config/settings.js` - 配置管理
- OpenClaw配置模板

### 风险评估
- **低风险**：仅涉及基础架构，无复杂业务逻辑

---

## 📝 **阶段2a：内容抓取与处理基础 (v0.1.0)**

### 阶段目标
实现通用的网页内容抓取和基础处理能力，支持多种来源链接

### 开发范围
- **通用网页抓取器**：支持HTTP/HTTPS链接
- **多来源适配**：
  - 普通网页文章（博客、新闻、技术文档等）
  - 微信公众号文章（尝试抓取，失败时优雅降级）
  - 技术博客、新闻网站等
- **异常处理机制**：
  - 网络超时处理（15秒超时）
  - HTTP错误状态码处理（404, 500等）
  - 内容解析失败处理
  - 反爬虫策略应对（User-Agent设置）
- **内容提取**：
  - 标题提取
  - 正文内容提取（HTML转Markdown）
  - 发布时间提取
  - 图片链接提取

### 验收标准 ✅
- [x] 发送普通网页链接 → 成功抓取标题和内容  
- [x] 发送无效链接 → 返回友好的错误信息
- [x] 发送超时链接 → 15秒后返回超时错误
- [x] 内容成功转换为Markdown格式
- [x] 支持至少3种不同来源的网站
- [ ] 微信/知乎文章 → 尝试抓取，失败时保存链接并提示

### 预期交付物
- `handlers/article-handler.js` - 文章处理入口
- `lib/web-fetcher.js` - 通用网页抓取器（轻量级）
- `lib/content-extractor.js` - 内容提取工具
- 完整的异常处理和错误日志

### 风险评估
- **中等风险**：网络抓取的不确定性较高，需要充分的异常处理
- **微信/知乎限制**：接受部分失败，提供优雅降级方案

---

## 🤖 **阶段2b：AI模型集成与智能处理 (v0.1.1)**

### 阶段目标
集成AI模型进行智能分类、摘要和关键词提取

### 开发范围
- **AI模型调用封装**：
  - OpenClaw内置模型调用
  - 备用Dashscope API调用（如果内置模型不可用）
- **智能处理功能**：
  - 自动分类（从预设分类中选择）
  - 摘要生成（100-150字）
  - 关键词提取（3-5个）
- **提示词工程**：
  - 优化AI提示词以获得最佳结果
  - 支持结果格式标准化
- **调试和监控**：
  - AI调用日志记录
  - 结果质量监控
  - 失败重试机制

### 验收标准 ✅
- [x] AI模型成功调用并返回结构化结果
- [x] 分类结果来自预设列表：前端、后端、大数据、AI、自动驾驶、数据闭环、仿真评测、产品、设计、生活
- [x] 摘要长度控制在100-150字
- [x] 关键词提取3-5个，用逗号分隔
- [x] AI调用失败时有备用方案或友好错误提示
- [x] 结果格式标准化，便于后续处理

### 预期交付物
- `lib/ai-client.js` - AI模型调用封装
- `lib/prompt-engine.js` - 提示词管理
- AI调用日志和监控工具
- 结果解析和验证工具

### 风险评估
- **中等风险**：依赖AI模型的稳定性和响应质量

---

## 🗃️ **阶段3：文章存储与入库 (v0.2.0)**

### 阶段目标
实现文章内容的持久化存储和数据库记录，解决链接过期问题

### 开发范围
- **文件系统存储**：
  - 按年月目录组织文章文件
  - 文件命名规范（时间戳）
  - 文件权限和安全
- **数据库操作**：
  - 文章记录插入（URL、标题、分类、摘要、关键词、文件路径等）
  - 数据完整性验证
  - 事务处理
- **链接保存机制**：
  - 即使抓取失败，也保存原始链接
  - 标记处理状态（pending/processed/failed）
- **存储优化**：
  - 大文件处理
  - 存储空间监控
  - 清理策略

### 验收标准 ✅
- [ ] 文章内容正确保存到 `articles/YYYY/MM/` 目录
- [ ] 数据库记录包含：URL、标题、分类、摘要、关键词、文件路径、创建时间
- [ ] 文件命名符合规范（如：1708156800000.md）
- [ ] 数据库操作原子性保证
- [ ] 存储失败时有回滚机制
- [ ] 链接过期问题解决（内容已本地保存）

### 预期交付物
- `lib/file-manager.js` - 文件系统操作
- `lib/storage-manager.js` - 存储管理
- 数据库操作工具函数
- 存储监控和清理工具

### 风险评估
- **低风险**：主要是本地文件和数据库操作

---

## 🔁 **阶段3b：微信/知乎收藏同步 (v0.2.1)**

### 阶段目标
实现微信和知乎收藏内容的自动同步，解决反爬虫问题

### 开发范围
- **微信收藏同步**：
  - 通过个人token访问微信收藏API
  - 定期同步（每小时一次）
  - 自动获取完整文章内容
  - AI处理并保存到知识库
- **知乎收藏同步**：
  - 通过用户cookie访问知乎收藏
  - 定期同步（每小时一次）
  - 内容获取和处理
  - 错误处理和降级机制
- **同步管理**：
  - 同步状态跟踪
  - 去重处理
  - 错误重试机制
- **用户配置**：
  - Token/Cookie安全存储
  - 同步频率配置
  - 手动触发同步

### 验收标准 ✅
- [ ] 微信收藏同步成功率 ≥ 90%
- [ ] 知乎收藏同步成功率 ≥ 80%
- [ ] 同步频率可配置（默认每小时）
- [ ] Token/Cookie安全存储（本地加密）
- [ ] 支持手动触发同步
- [ ] 自动去重，避免重复处理

### 预期交付物
- `lib/wechat-sync.js` - 微信收藏同步
- `lib/zhihu-sync.js` - 知乎收藏同步
- `handlers/sync-handler.js` - 同步管理
- Token管理工具
- 同步状态监控

### 风险评估
- **中等风险**：依赖第三方API稳定性
- **Token管理**：需要安全的本地存储方案

---

## 🖼️ **阶段4：图片管理功能 (v0.3.0)**

### 阶段目标
实现图片上传和元数据管理功能

### 开发范围
- 图片文件接收和存储
- 文字说明解析（标题、分类、摘要）
- 图片元数据存储到数据库
- 图片文件保存到指定目录

### 验收标准 ✅
- [ ] 发送图片 + "标题:xxx 分类:xxx 摘要:xxx" → 成功处理
- [ ] 图片正确保存到 `images/YYYY/MM/` 目录
- [ ] 数据库记录包含：标题、分类、摘要、图片路径
- [ ] 分类验证：必须是预设分类之一
- [ ] 返回确认消息格式正确

### 预期交付物
- `handlers/image-handler.js` - 图片处理核心逻辑
- 图片存储和管理工具
- 文字说明解析工具函数

### 风险评估
- **低风险**：主要涉及文件操作，逻辑相对简单

---

## 🔍 **阶段5：智能搜索功能 (v0.4.0)**

### 阶段目标
实现完整的知识库搜索功能

### 开发范围
- 搜索命令解析（关键词、分类、时间范围）
- SQL查询构建和执行
- 搜索结果格式化
- 支持多种时间范围（本周、本月、今年）

### 验收标准 ✅
- [ ] 发送"搜索 Git" → 返回匹配的文章和图片
- [ ] 发送"搜索 分类:AI" → 只返回AI分类的内容
- [ ] 发送"搜索 时间:week" → 只返回本周的内容
- [ ] 支持组合查询："搜索 Git 分类:后端 时间:week"
- [ ] 搜索结果格式正确，包含图标、标题、分类、时间、摘要

### 预期交付物
- `handlers/search-handler.js` - 搜索处理核心逻辑
- `lib/search-builder.js` - SQL查询构建器
- 搜索结果格式化工具

### 风险评估
- **低风险**：主要是数据库查询和结果处理

---

## 🧪 **阶段6：测试与优化 (v0.5.0)**

### 阶段目标
完善测试覆盖，优化性能和用户体验

### 开发范围
- 单元测试和集成测试
- 性能优化（并发处理、缓存等）
- 错误处理改进
- 用户体验优化

### 验收标准 ✅
- [ ] 核心功能单元测试覆盖率 ≥ 80%
- [ ] 处理时间优化：文章处理 < 10秒
- [ ] 完善的错误处理：网络超时、AI调用失败、文件写入失败等
- [ ] 日志记录完整，便于调试
- [ ] 内存使用合理，无内存泄漏

### 预期交付物
- `tests/` 目录 - 完整的测试套件
- 性能监控工具
- 错误处理和日志记录改进
- 用户体验优化

### 风险评估
- **低风险**：主要是质量改进，不影响核心功能

---

## 🏁 **阶段7：生产部署 (v1.0.0)**

### 阶段目标
完成生产环境部署，确保系统稳定运行

### 开发范围
- 生产环境配置
- 部署脚本和自动化
- 监控和告警
- 文档完善

### 验收标准 ✅
- [ ] 生产环境稳定运行 ≥ 1周
- [ ] 部署脚本支持一键部署和回滚
- [ ] 监控覆盖：CPU、内存、磁盘、错误率
- [ ] 完整的用户文档和开发者文档
- [ ] 备份和恢复机制验证

### 预期交付物
- `deploy/` 目录 - 部署脚本和配置
- 监控和告警配置
- 完整的文档
- 备份和恢复方案

### 风险评估
- **中等风险**：生产环境稳定性要求高

---

## 📊 **里程碑规划**

| 阶段 | 版本 | 预计周期 | 依赖关系 | 状态 |
|------|------|----------|----------|------|
| 阶段1 | v0.0.1 | 1-2天 | 无 | ✅ 完成 |
| 阶段2a | v0.1.0 | 3-4天 | 阶段1 | ✅ 完成 |
| 阶段2b | v0.1.1 | 2-3天 | 阶段2a | ✅ 完成 |
| 阶段3 | v0.2.0 | 2-3天 | 阶段2b | 🔄 进行中 |
| 阶段3b | v0.2.1 | 3-4天 | 阶段3 | ⏳ 待token |
| 阶段4 | v0.3.0 | 2-3天 | 阶段1 | ⏳ |
| 阶段5 | v0.4.0 | 2-3天 | 阶段1 | ⏳ |
| 阶段6 | v0.5.0 | 3-5天 | 阶段2-5 | ⏳ |
| 阶段7 | v1.0.0 | 2-3天 | 阶段6 | ⏳ |

## 🔧 **关键改进点**

### 用户体验优化
1. **极简操作**: 用户只需复制链接或使用原生收藏功能
2. **智能降级**: 抓取失败时自动保存链接，不丢失信息
3. **统一入口**: 所有操作通过同一机器人完成
4. **零后续工作**: 自动化处理，无需用户补充操作

### 技术栈统一
- **语言**: Node.js (ES6+)
- **数据库**: SQLite3
- **测试框架**: Jest
- **代码风格**: Standard JS
- **版本控制**: Git + GitHub
- **部署**: Shell脚本 + OpenClaw集成

### 资源优化
- **轻量级**: 移除浏览器依赖，降低内存消耗
- **单线程**: 避免并发问题，适合2G服务器
- **高效存储**: 本地文件系统 + SQLite，无需额外服务

## 🎯 **使用流程**

### 日常使用
1. **看到好文章** → 复制链接发送给机器人 **或** 使用微信/知乎原生收藏
2. **系统自动处理** → 抓取内容 + AI分析 + 本地存储
3. **后续查找** → 通过搜索命令快速定位

### 特殊情况处理
- **普通网站**: 100%自动处理
- **微信/知乎**: 
  - 优先通过收藏同步（90%+成功率）
  - 直接链接尝试抓取（部分成功率）
  - 失败时保存链接，不丢失信息

## 💡 **AI模型调用策略**

### 主要调用方式
- **OpenClaw内置模型**: 通过 `http://localhost:18324/ec8106e5/completion` 调用
- **模型ID**: `alibaba-cloud/qwen3-max-2026-01-23`
- **优势**: 复用现有认证和配置

### 备用方案
- **直接Dashscope API**: 如果OpenClaw接口不可用时的降级方案
- **需要配置**: `DASHSCOPE_API_KEY` 环境变量

## 🛡️ **错误处理策略**

### 网络抓取失败
- **策略**: 保存原始链接，标记为待处理
- **用户交互**: "🔗 链接已保存！内容将在收藏同步时自动获取。"

### AI调用失败  
- **策略**: 直接报错
- **用户交互**: "❌ AI模型调用失败，请检查配置或稍后重试。"

### 同步失败
- **策略**: 自动重试 + 手动触发选项
- **用户交互**: "🔄 同步失败，已安排重试。回复'手动同步'立即重试。"

---

**文档版本**: v1.0.0  
**最后更新**: 2026-02-22  
**状态**: MVP版本规划完成，等待token实施阶段3b